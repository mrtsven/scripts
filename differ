#!/usr/bin/env bash

bold=$(tput bold)
normal=$(tput sgr0)
green=$(tput setaf 2)
blue=$(tput setaf 4)
yellow=$(tput setaf 3)
cyan=$(tput setaf 6)

REPOS=("waiter" "backoffice" "api" "shared" "shared-client" "cron" "consumer")

REPO=""
SOURCE=""
DEST=""
STEP=1

OS_TYPE="$(uname -s)"
URL=''

COPY_MODE=false

function check_xclip() {
    if command -v xclip >/dev/null 2>&1; then
        echo "xclip is installed."
    else
        echo "xclip is not installed."
        COPY_MODE=false
    fi
}

function check_xdg_open() {
    if command -v xdg-open >/dev/null 2>&1; then
        echo "xdg-open is installed."
    else
        echo "xdg-open is not installed. Please install "xdg-utils" using your package manager and try again."
        COPY_MODE=false
    fi
}

function validate_repo() {
    local input_repo="$1"
    for valid_repo in "${REPOS[@]}"; do
        if [[ "$valid_repo" == "$input_repo" ]]; then
            return 0
        fi
    done

    echo -e "${yellow}⚠ Invalid repo:${normal} '$input_repo'"
    echo "Available repositories:"
    for r in "${REPOS[@]}"; do
        echo "  - $r"
    done
    exit 1
}

# Parse command-line options
while [[ $# -gt 0 ]]; do
  case "$1" in
    -c)
      COPY_MODE=true
      shift
      ;;
    --repo=*)
      REPO="${1#*=}"
      validate_repo "$REPO"
      shift
      ;;
    -*)
      echo "Unknown option: $1"
      echo "Usage: $0 [-c] [--repo=<name>] [source] [dest]"
      exit 1
      ;;
    *)
      # Positional arguments (commits/branches)
      if [[ -z "$SOURCE" ]]; then
        SOURCE="$1"
      elif [[ -z "$DEST" ]]; then
        DEST="$1"
      else
        echo "Too many arguments."
        echo "Usage: $0 [-c] [--repo=<name>] [source] [dest]"
        exit 1
      fi
      shift
      ;;
  esac
done

function end_message() {
    if [ "$COPY_MODE" = true ]; then
        echo -e "${green}✔${normal} URL copied to clipboard."
    else
        echo -e "${green}✔${normal} Opening comparison in browser..."
    fi

    exit 0;
}

function determine_os() {
    case "$OS_TYPE" in
    Darwin)
        if [ "$COPY_MODE" = true ]; then      
            echo -n "$URL" | pbcopy
        else
            open "$URL"
        fi
        ;;
    Linux)
        # Check if running under WSL
        if grep -qi microsoft /proc/version; then
        explorer.exe "$URL"
        else
            if [ "$COPY_MODE" = true ]; then
                check_xclip
                echo -n "$URL" | xclip -selection clipboard
            else
                check_xdg_open
                xdg-open "$URL"
            fi
        fi
        ;;
    CYGWIN*|MINGW*|MSYS*)
        start "$URL"
        ;;
    *)
        echo "Unknown OS: $OS_TYPE"
        ;;
    esac
}



# Function to render the current status line
function render_status() {
    clear
    echo -e "${bold}Repo:${normal} '${cyan}${REPO}${normal}' | ${bold}Source:${normal} '${cyan}${SOURCE}${normal}' | ${bold}Dest:${normal} '${cyan}${DEST}${normal}'"
    echo -e "${bold}Step:${normal} ${yellow}${STEP}${normal} | ${bold}Copy Mode:${normal} ${yellow}${COPY_MODE}${normal}"
    echo ""
}

# Fast mode: if repo + source + dest are all set, skip interactive mode
if [[ -n "$REPO" && -n "$SOURCE" && -n "$DEST" ]]; then
    URL="https://bitbucket.org/possys/${REPO}/branches/compare/${SOURCE}%0D${DEST}#diff"
    determine_os
    end_message
fi

while true; do
    render_status

    case $STEP in
        1) # Step 1: Select Repo
            echo "Select a repository:"
            select CHOICE in "${REPOS[@]}" "Back"; do
                if [[ "$REPLY" -eq $((${#REPOS[@]} + 1)) ]]; then
                    echo -e "${red}You're already at the first step.${normal}"
                elif [[ -n "$CHOICE" ]]; then
                    REPO="$CHOICE"
                    STEP=2
                    break
                else
                    echo -e "${red}Invalid selection. Try again.${normal}"
                fi
            done
            ;;
        2) # Step 2: Enter Source
            read -p "Enter source branch (or type 'b' to go back): " input
            if [[ "$input" == "b" ]]; then
                REPO=""
                STEP=1
            elif [[ -n "$input" ]]; then
                SOURCE="$input"
                STEP=3
            fi
            ;;
        3) # Step 3: Enter Dest
            read -p "Enter destination branch (or type 'b' to go back): " input
            if [[ "$input" == "b" ]]; then
                SOURCE=""
                STEP=2
            elif [[ -n "$input" ]]; then
                DEST="$input"
                STEP=4
            fi
            ;;
        4) # Final step: Confirm and open
            URL="https://bitbucket.org/possys/${REPO}/branches/compare/${SOURCE}%0D${DEST}#diff"

            determine_os
            end_message
            break
            ;;
    esac
done

